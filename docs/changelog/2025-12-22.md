# 2025-12-22

## 변경
- 프롬프트 평가 정확도 개선: 평가 프롬프트에 실제 적용된 프롬프트(질문 치환본) 포함, 중복 프롬프트 생성 제거.
- 실패 응답 처리: 평가 입력에서 실패 응답 제외, 결과에 `score=-1`으로 보강.
- 평가 출력 안정화: JSON 예시를 평가 프롬프트에 추가해 파싱 안정성 강화.

## 파일별 변경
- `app/services/chat_graph/nodes.py`: 현재 질문을 히스토리에서 제외해 프롬프트 분리 정확도 개선, 응답 메타에 출처 목록 추가, DeepSeek 노드 추가.
- `app/services/chat_graph/workflow.py`: DeepSeek 노드를 워크플로우에 추가, `llm_registry` 경로를 shared로 이동.
- `app/services/prompt_eval/runner.py`: DeepSeek 생성/평가 추가, 응답 메타에 출처 목록 포함, `llm_registry` 경로를 shared로 이동.
- `app/services/shared/llm_registry.py`: 공통 LLM 레지스트리로 이동.
- `app/services/shared/model_aliases.py`: DeepSeek 평가 모델 추가, Groq/Cohere 최신 평가 모델 갱신.
- `app/ui/streamlit_app.py`: DeepSeek 모델 선택/그래프 표시, 응답 메타·출처 표시 강화, 기본 모델 선택 로그 중복 제거, Groq/Cohere 모델 목록 갱신.
- `app/utils/config.py`: DeepSeek 기본 모델/베이스 URL 추가, Groq/Cohere 기본 모델 갱신.
- `app/api/routes.py`: chat/prompt-eval 응답에 `response_meta` 포함.
- `.env.example`: DeepSeek 환경 변수 예시 추가.
- `app/services/chat_graph/README.md`: 공통 `llm_registry` 경로 갱신.
- `app/services/prompt_eval/runner.py`: 평가 입력에는 출처 포함 응답 사용, UI 표기는 분리.
- `app/services/chat_graph/nodes.py`: 본문 출처 강제 삽입 제거(출처는 UI에서 분리 표시).
- `app/services/shared/errors.py`: 공통 에러 헬퍼로 이동, chat_graph/prompt_eval에서 공용 사용.
- `app/utils/config.py`: OpenAI 기본 모델을 `gpt-4.1-mini`로 변경.
- `app/ui/streamlit_app.py`: OpenAI 모델 목록을 `gpt-4o`, `gpt-4.1`, `gpt-4.1-mini`로 교체하고 기본값 반영.
- `app/api/routes.py`, `app/api/schemas/ask.py`: OpenAI 모델 예시를 `gpt-4.1-mini`로 갱신.
- `app/services/prompt_eval/runner.py`: 프롬프트 평가에 모델 오버라이드 적용.
- `app/api/schemas/prompt_eval.py`, `app/api/routes.py`: `model_overrides` 요청 필드 추가.
- `app/ui/streamlit_app.py`: 사이드바 모델 선택을 프롬프트 평가 요청에 전달.
- `app/services/chat_graph/nodes.py`: 히스토리 유무에 따른 프롬프트 분기 복구 및 JSON 출력 혼합 시 파싱 보강.
- `app/services/chat_graph/nodes.py`: LangChain 메시지 타입에서 현재 질문/히스토리 분리 정확도 보강.
- `app/services/chat_graph/summaries.py`: 로그 미리보기에서 문자열 잘림 제거.
- `app/api/routes.py`: `/api/ask` 문서에 히스토리/현재 질문 분리 안내 추가.
- `app/ui/streamlit_app.py`: 프롬프트 평가 상세 표에 평가자 모델명 표시.

## 참고
- 평가 파이프라인 변경은 `app/services/prompt_eval/runner.py`에 반영됨.
